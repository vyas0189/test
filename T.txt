import json
from flask import Flask, request, jsonify

app = Flask(__name__)

@app.route('/bitbucket-webhook', methods=['POST'])
def bitbucket_webhook():
    event_key = request.headers.get('X-Event-Key')
    payload = request.get_json()

    # Print the payload in JSON format with indentation for readability
    print("Received payload:")
    print(json.dumps(payload, indent=4))

    if event_key == "pullrequest:comment_created":
        pr_id = payload.get("pullrequest", {}).get("id")
        print(f"Comment added on PR: {pr_id}")
    elif event_key == "pullrequest:approved":
        pr_id = payload.get("pullrequest", {}).get("id")
        print(f"PR Approved: {pr_id}")
    elif event_key == "pullrequest:rejected":
        pr_id = payload.get("pullrequest", {}).get("id")
        print(f"PR Declined: {pr_id}")
    else:
        print(f"Unhandled event: {event_key}")

    return jsonify({"status": "ok"}), 200

if __name__ == '__main__':
    app.run(port=3000, debug=True)
