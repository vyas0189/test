$API_KEY="key_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; $headers=@{"Authorization"="Basic $([Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${API_KEY}:")))"; "Content-Type"="application/json"}; $months=0..3|ForEach-Object{$d=(Get-Date).AddMonths(-$_);@{Y=$d.Year;M=$d.Month;D=$d.ToString("yyyy-MM");S=[DateTimeOffset]::new($d.Year,$d.Month,1,0,0,0,[TimeSpan]::Zero).ToUnixTimeMilliseconds();E=[DateTimeOffset]::new($d.Year,$d.Month,[DateTime]::DaysInMonth($d.Year,$d.Month),23,59,59,[TimeSpan]::Zero).ToUnixTimeMilliseconds()}}; $allData=@(); foreach($m in $months){$page=1; do{$r=Invoke-RestMethod -Uri "https://api.cursor.com/teams/filtered-usage-events" -Method POST -Headers $headers -Body (@{startDate=$m.S;endDate=$m.E;page=$page;pageSize=100}|ConvertTo-Json); foreach($e in $r.events){$allData+=[PSCustomObject]@{Date=$m.D;Year=$m.Y;Month=$m.M;Email=$e.email;SpendDollars=$e.tokenUsage.totalCents/100}}; $page++; Start-Sleep -Milliseconds 200}while($r.events.Count -eq 100)}; $allData|Group-Object Date,Email|ForEach-Object{[PSCustomObject]@{Date=$_.Group[0].Date;Email=$_.Group[0].Email;TotalSpend=($_.Group|Measure-Object -Property SpendDollars -Sum).Sum}}|Sort-Object Date,Email|Export-Csv -Path "cursor-monthly-spend.csv" -NoTypeInformation; Write-Host "Exported to cursor-monthly-spend.csv" -ForegroundColor Green
