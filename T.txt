kind: ConfigMap
metadata:
  name: intake-ui-fb-agent-config
data:
  fluent-bit.conf: |-
    # Parsers for NGINX log formats
    [PARSER]
        Name   nginx_access
        Format regex
        Regex  ^(?<remote_addr>\S+) - (?<remote_user>\S+) \[(?<time_local>[^\]]+)\] "(?<request>[^"]*)" (?<status>\d+) (?<body_bytes_sent>\d+) "(?<http_referer>[^"]*)" "(?<http_user_agent>[^"]*)"

    [PARSER]
        Name   nginx_error
        Format regex
        Regex  ^(?<time>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>\w+)\] (?<message>.*)$

    # Input for access.log
    [INPUT]
        Name              tail
        Path              ${LOG_PATH_ACCESS}
        Tag               nginx.access
        Parser            nginx_access
        Mem_Buf_Limit     25MB
        Buffer_Max_Size   5MB
        Refresh_Interval  60

    # Input for error.log
    [INPUT]
        Name              tail
        Path              ${LOG_PATH_ERROR}
        Tag               nginx.error
        Parser            nginx_error
        Mem_Buf_Limit     25MB
        Buffer_Max_Size   5MB
        Refresh_Interval  60

    # Filter to add Kubernetes and app metadata
    [FILTER]
        Name              record_modifier
        Match             *
        Record            Kubernetes.node ${K8S_NODE_NAME}
        Record            Kubernetes.pod ${K8S_POD_NAME}
        Record            Kubernetes.namespace ${K8S_NAMESPACE}
        Record            appId ${APP_ID}
        Record            appModule ${APP_MODULE}

    # Output to forward logs to the specified host
    [OUTPUT]
        Name              forward
        Match             *
        Host              ${PPA_HOST}
        Port              ${PPA_PORT}
        tls               on
        tls.verify        off
        Empty_Shared_Key  True
